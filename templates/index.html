{% extends "base.html" %}
{% block title %}Gh√©p √¢m thanh - Ngh·ªã Edition{% endblock %}
{% block content %}
<h1 class="text-2xl font-bold text-blue-700 mb-4">üé∂ Gh√©p file √¢m thanh</h1>
<form method="post" enctype="multipart/form-data" class="space-y-4">
    <label class="block font-medium mb-1">Ch·ªçn file √¢m thanh (c√≥ th·ªÉ ch·ªçn nhi·ªÅu, gi·ªØ ƒë√∫ng th·ª© t·ª± b·∫°n mu·ªën gh√©p):</label>
    <input type="file" name="files" accept=".mp3,.wav,.ogg,.flac" multiple required class="block mb-2 border p-2 rounded w-full" onchange="updateFileList(this)">
    <div id="file-list"></div>
    <label class="block font-medium mt-3 mb-1">T√™n file xu·∫•t ra:</label>
    <input type="text" name="output_name" id="output_name" class="border p-2 rounded w-full" placeholder="V√≠ d·ª•: Video STT 1 NghiLam" value="{{ output_name if output_name is defined else '' }}" required>
    <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-semibold transition">
        üü¢ Gh√©p l·∫°i l√†m 1
    </button>
</form>
{% if file_infos and file_infos|length > 0 %}
<div class="mt-4">
    <h3 class="font-semibold text-gray-700 mb-2">Danh s√°ch file s·∫Ω gh√©p (th·ª© t·ª± gi·ªØ nguy√™n):</h3>
    <table class="w-full text-left border border-gray-200 bg-gray-50 rounded">
        <thead><tr class="bg-gray-100">
            <th class="px-2 py-1">STT</th>
            <th class="px-2 py-1">T√™n file</th>
            <th class="px-2 py-1">Th·ªùi l∆∞·ª£ng</th>
        </tr></thead>
        <tbody>
        {% for f in file_infos %}
        <tr>
            <td class="px-2">{{ loop.index }}</td>
            <td class="px-2">{{ f.name }}</td>
            <td class="px-2">{{ f.duration }}</td>
        </tr>
        {% endfor %}
        </tbody>
    </table>
</div>
{% endif %}
{% if merged_file %}
<div class="mt-6 bg-green-100 text-green-800 rounded p-4 text-center shadow">
    <div class="text-lg mb-1 font-bold">‚úÖ Gh√©p th√†nh c√¥ng!</div>
    <div>Th·ªùi l∆∞·ª£ng file m·ªõi: <span class="font-semibold">{{ merged_duration }}</span></div>
    <a id="download-link" href="{{ merged_url }}" class="block mt-2 px-4 py-2 bg-blue-700 text-white rounded hover:bg-blue-800 font-semibold transition">
        ‚¨áÔ∏è T·∫£i file gh√©p v·ªÅ
    </a>
</div>
<script>
    // Khi ƒë√£ c√≥ file gh√©p m√† ch∆∞a t·∫£i => b·∫≠t c·∫£nh b√°o
    let downloaded = false;
    window.onbeforeunload = function(e) {
        if (!downloaded) {
            e.preventDefault();
            e.returnValue = 'B·∫°n ch∆∞a t·∫£i file gh√©p v·ªÅ! B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën r·ªùi kh·ªèi trang n√†y?';
            return e.returnValue;
        }
    };
    document.getElementById('download-link').addEventListener('click', function(){
        downloaded = true;
        window.onbeforeunload = null; // T·∫Øt c·∫£nh b√°o sau khi t·∫£i
        // reset giao di·ªán nh∆∞ c≈© n·∫øu c·∫ßn
        setTimeout(function(){ window.location.href = "/"; }, 300);
    });
</script>
{% endif %}
<script>
function updateFileList(input) {
    let files = input.files;
    let html = '';
    if(files.length) {
        html = '<div class="mt-4"><h3 class="font-semibold text-gray-700 mb-2">Danh s√°ch file s·∫Ω gh√©p (theo th·ª© t·ª±):</h3><ol class="list-decimal list-inside">';
        for(let i=0; i<files.length; i++) {
            html += `<li><span class='font-mono'>${files[i].name}</span></li>`;
        }
        html += '</ol></div>';
    }
    document.getElementById('file-list').innerHTML = html;
}
</script>
{% endblock %}
